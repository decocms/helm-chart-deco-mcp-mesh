apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "chart-deco-mcp-mesh.fullname" . }}
  labels:
    {{- include "chart-deco-mcp-mesh.labels" . | nindent 4 }}
spec:
  {{- if not .Values.autoscaling.enabled }}
  replicas: {{ .Values.replicaCount }}
  {{- end }}
  strategy:
    type: {{ include "chart-deco-mcp-mesh.deploymentStrategy" . }}
    {{- $strategyType := include "chart-deco-mcp-mesh.deploymentStrategy" . }}
    {{- if eq $strategyType "RollingUpdate" }}
    rollingUpdate:
      {{- if and .Values.strategy .Values.strategy.rollingUpdate }}
      {{- toYaml .Values.strategy.rollingUpdate | nindent 6 }}
      {{- else }}
      maxSurge: 1
      maxUnavailable: 0
      {{- end }}
    {{- end }}
  selector:
    matchLabels:
      {{- include "chart-deco-mcp-mesh.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      {{- with .Values.podAnnotations }}
      annotations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      labels:
        {{- include "chart-deco-mcp-mesh.labels" . | nindent 8 }}
        {{- with .Values.podLabels }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "chart-deco-mcp-mesh.serviceAccountName" . }}
      securityContext:
        {{- include "chart-deco-mcp-mesh.podSecurityContext" . | nindent 8 }}
      {{- if .Values.secret.authConfigSecretName }}
      initContainers:
        - name: update-auth-config
          image: alpine/k8s:1.28.0
          command:
            - /bin/sh
            - -c
            - |
              set -e
              apk add --no-cache jq > /dev/null 2>&1
              echo "Reading auth secrets from Secret: {{ .Values.secret.authConfigSecretName }}"
              
              # Read secrets
              GOOGLE_CLIENT_ID=$(kubectl get secret {{ .Values.secret.authConfigSecretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.googleClientId}' 2>/dev/null | base64 -d || echo "")
              GOOGLE_CLIENT_SECRET=$(kubectl get secret {{ .Values.secret.authConfigSecretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.googleClientSecret}' 2>/dev/null | base64 -d || echo "")
              GITHUB_CLIENT_ID=$(kubectl get secret {{ .Values.secret.authConfigSecretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.githubClientId}' 2>/dev/null | base64 -d || echo "")
              GITHUB_CLIENT_SECRET=$(kubectl get secret {{ .Values.secret.authConfigSecretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.githubClientSecret}' 2>/dev/null | base64 -d || echo "")
              RESEND_API_KEY=$(kubectl get secret {{ .Values.secret.authConfigSecretName }} -n {{ .Release.Namespace }} -o jsonpath='{.data.resendApiKey}' 2>/dev/null | base64 -d || echo "")
              
              if [ -z "$GOOGLE_CLIENT_ID" ] && [ -z "$GITHUB_CLIENT_ID" ]; then
                echo "Warning: No secrets found, skipping update"
                exit 0
              fi
              
              # Read current ConfigMap
              CURRENT_CONFIG=$(kubectl get configmap {{ include "chart-deco-mcp-mesh.fullname" . }}-auth-config -n {{ .Release.Namespace }} -o jsonpath='{.data.auth-config\.json}' 2>/dev/null || echo "{}")
              
              # Update JSON with secret values if they're empty
              UPDATED_CONFIG=$(echo "$CURRENT_CONFIG" | jq --arg gid "$GOOGLE_CLIENT_ID" --arg gsec "$GOOGLE_CLIENT_SECRET" --arg ghid "$GITHUB_CLIENT_ID" --arg ghsec "$GITHUB_CLIENT_SECRET" --arg rkey "$RESEND_API_KEY" '
                if $gid != "" and (.socialProviders.google.clientId == "" or .socialProviders.google.clientId == null) then .socialProviders.google.clientId = $gid else . end |
                if $gsec != "" and (.socialProviders.google.clientSecret == "" or .socialProviders.google.clientSecret == null) then .socialProviders.google.clientSecret = $gsec else . end |
                if $ghid != "" and (.socialProviders.github.clientId == "" or .socialProviders.github.clientId == null) then .socialProviders.github.clientId = $ghid else . end |
                if $ghsec != "" and (.socialProviders.github.clientSecret == "" or .socialProviders.github.clientSecret == null) then .socialProviders.github.clientSecret = $ghsec else . end |
                if $rkey != "" then (.emailProviders[] | select(.id == "resend-primary") | if (.config.apiKey == "" or .config.apiKey == null) then .config.apiKey = $rkey else . end) else . end
              ')
              
              # Convert JSON object to compact JSON string
              JSON_STRING=$(echo "$UPDATED_CONFIG" | jq -c .)
              
              # Use kubectl apply method - more reliable than patch for ConfigMaps
              echo "Updating ConfigMap using kubectl apply..."
              TEMP_FILE="/tmp/configmap-update.json"
              
              # Get current ConfigMap, update the data field with the new JSON string
              # Add annotation to prevent ArgoCD from reverting (if using sync-options)
              kubectl get configmap {{ include "chart-deco-mcp-mesh.fullname" . }}-auth-config -n {{ .Release.Namespace }} -o json | \
                jq --arg jsonstr "$JSON_STRING" '.data["auth-config.json"] = $jsonstr | .metadata.annotations["argocd.argoproj.io/sync-options"] = "Replace=true"' > "$TEMP_FILE"
              
              # Apply the updated ConfigMap
              if kubectl apply -f "$TEMP_FILE" -n {{ .Release.Namespace }} 2>&1; then
                echo "Auth config updated successfully"
                
                # Verify the update
                sleep 2
                VERIFIED=$(kubectl get configmap {{ include "chart-deco-mcp-mesh.fullname" . }}-auth-config -n {{ .Release.Namespace }} -o jsonpath='{.data.auth-config\.json}' 2>/dev/null | jq -r '.socialProviders.google.clientId // ""' 2>/dev/null || echo "")
                if [ -n "$VERIFIED" ] && [ "$VERIFIED" != "" ]; then
                  echo "Verification: ConfigMap updated correctly (google clientId: ${VERIFIED:0:20}...)"
                  
                  # Force Pod restart by updating deployment annotation
                  # This ensures the Pod picks up the new ConfigMap
                  kubectl patch deployment {{ include "chart-deco-mcp-mesh.fullname" . }} -n {{ .Release.Namespace }} \
                    --type merge -p '{"spec":{"template":{"metadata":{"annotations":{"auth-config-updated":"'$(date +%s)'"}}}}}' 2>/dev/null || true
                  echo "Deployment annotation updated to trigger Pod restart"
                else
                  echo "Warning: ConfigMap may not have been updated correctly (verification failed)"
                fi
                
                rm -f "$TEMP_FILE"
              else
                echo "ERROR: Failed to update ConfigMap"
                echo "JSON preview (first 200 chars):"
                echo "$JSON_STRING" | head -c 200
                echo ""
                rm -f "$TEMP_FILE"
                exit 1
              fi
      {{- end }}
      containers:
        - name: {{ .Chart.Name }}
          {{- with .Values.securityContext }}
          securityContext:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          image: "{{ .Values.image.repository }}{{- if and .Values.image.tag (hasPrefix "sha256:" .Values.image.tag) }}@{{ .Values.image.tag }}{{- else }}:{{ .Values.image.tag | default .Chart.AppVersion }}{{- end }}"
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.service.targetPort | default 3000 }}
              protocol: TCP
          env:
            - name: NODE_ENV
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: NODE_ENV
            - name: PORT
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: PORT
            - name: HOST
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: HOST
            - name: BETTER_AUTH_URL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: BETTER_AUTH_URL
            - name: BETTER_AUTH_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.secretName" . }}
                  key: BETTER_AUTH_SECRET
            - name: DATABASE_URL
              {{- if eq (lower (default "sqlite" .Values.database.engine)) "postgresql" }}
              valueFrom:
                secretKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.secretName" . }}
                  key: DATABASE_URL
              {{- else }}
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: DATABASE_URL
              {{- end }}
            - name: BASE_URL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: BASE_URL
            {{- if .Values.configMap.meshConfig.DATABASE_PG_SSL }}
            - name: DATABASE_PG_SSL
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: DATABASE_PG_SSL
            {{- end }}
            {{- if and .Values.configMap.meshConfig.NODE_EXTRA_CA_CERTS .Values.database.caCert }}
            - name: NODE_EXTRA_CA_CERTS
              valueFrom:
                configMapKeyRef:
                  name: {{ include "chart-deco-mcp-mesh.fullname" . }}-config
                  key: NODE_EXTRA_CA_CERTS
            {{- end }}
          {{- with .Values.livenessProbe }}
          livenessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.readinessProbe }}
          readinessProbe:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          {{- with .Values.resources }}
          resources:
            {{- toYaml . | nindent 12 }}
          {{- end }}
          volumeMounts:
            - name: auth-config
              mountPath: /app/apps/mesh/auth-config.json
              subPath: auth-config.json
              readOnly: true
            - name: data
              mountPath: /app/data
            {{- if and (eq (lower (default "sqlite" .Values.database.engine)) "postgresql") .Values.database.caCert }}
            - name: ca-cert
              mountPath: /etc/ssl/certs
              readOnly: true
            {{- end }}
          {{- with .Values.volumeMounts }}
            {{- toYaml . | nindent 12 }}
          {{- end }}
      {{- with .Values.extraContainers }}
      {{- toYaml . | nindent 8 }}
      {{- end }}
      volumes:
        - name: auth-config
          configMap:
            name: {{ include "chart-deco-mcp-mesh.fullname" . }}-auth-config
            items:
              - key: auth-config.json
                path: auth-config.json
        {{- if and (eq (lower (default "sqlite" .Values.database.engine)) "postgresql") .Values.database.caCert }}
        - name: ca-cert
          configMap:
            name: {{ include "chart-deco-mcp-mesh.fullname" . }}-ca-cert
            items:
              - key: ca-cert.pem
                path: ca-cert.pem
        {{- end }}
        {{- if .Values.persistence.enabled }}
        - name: data
          {{- if .Values.persistence.claimName }}
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.claimName }}
          {{- else }}
          persistentVolumeClaim:
            claimName: {{ include "chart-deco-mcp-mesh.fullname" . }}-data
          {{- end }}
        {{- else }}
        - name: data
          emptyDir: {}
        {{- end }}
        {{- with .Values.volumes }}
          {{- toYaml . | nindent 8 }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if and .Values.topologySpreadConstraints (gt (len .Values.topologySpreadConstraints) 0) }}
      topologySpreadConstraints:
        {{- range .Values.topologySpreadConstraints }}
        - {{- if not .labelSelector }}
          {{- fail "labelSelector é obrigatório em topologySpreadConstraints. Especifique explicitamente os labels." }}
          {{- else }}
          labelSelector:
            {{- toYaml .labelSelector | nindent 12 }}
          {{- end }}
          maxSkew: {{ .maxSkew }}
          topologyKey: {{ .topologyKey }}
          whenUnsatisfiable: {{ .whenUnsatisfiable }}
        {{- end }}
      {{- end }}
